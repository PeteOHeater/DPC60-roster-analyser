<!DOCTYPE html>
<html>
<head>
    <title>DPC 60 Roster Analyser</title>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 20px; background: #f0f2f5; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); max-width: 1600px; margin: auto; }
        h2 { color: #e21b22; margin-top: 0; border-bottom: 2px solid #e21b22; padding-bottom: 10px; }
        .controls { display: flex; gap: 20px; background: #fff5f5; padding: 15px; border-radius: 8px; margin: 15px 0; border: 1px solid #ffcfcf; align-items: center; }
        .input-group { display: flex; flex-direction: column; }
        input[type="number"], input[type="text"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        textarea { width: 100%; height: 100px; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-family: monospace; box-sizing: border-box; }
        button { background: #e21b22; color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; font-size: 16px; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 25px; font-size: 12px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #555; text-transform: uppercase; font-size: 10px; }
        
        /* Highlighting Logic */
        .margin-red { background-color: #fee2e2 !important; color: #b91c1c !important; font-weight: bold; } /* DPC60 Active */
        .margin-green { background-color: #dcfce7 !important; color: #166534 !important; font-weight: bold; } /* Simulation Active */
        .margin-amber { background-color: #fffbeb !important; color: #92400e !important; font-weight: bold; } /* Credit Active */
        
        .extra-gross { color: #000000 !important; font-weight: bold; } 
        .extra-net { color: #16a34a !important; font-weight: bold; }   
        .adj-input { width: 65px; padding: 6px; border: 2px solid #e21b22; border-radius: 4px; font-weight: bold; text-align: center; }
        .duty-col { color: #4b5563; font-style: italic; }
    </style>
</head>
<body>
<div class="card">
    <h2>DPC 60 Roster Analyser</h2>
    <div class="controls">
        <div class="input-group"><label>Hourly Rate ($)</label><input type="number" id="hourlyRate" value="353" oninput="updateAll()"></div>
        <div class="input-group"><label>Tax Rate (%)</label><input type="number" id="taxRate" value="47" oninput="updateAll()"></div>
    </div>
    <textarea id="rosterInput" placeholder="Paste daily roster here..."></textarea>
    <button onclick="processRoster()">Process Roster</button>
    <div id="tableContainer"></div>
</div>

<script>
let rosterData = [];

function parseTime(s) {
    if (!s || !s.includes(':')) return 0;
    const [h, m] = s.split(':').map(Number);
    return (h * 60) + m;
}

function formatTime(m) {
    const mins = Math.max(0, Math.round(m));
    return Math.floor(mins / 60) + ":" + (mins % 60).toString().padStart(2, '0');
}

function processRoster() {
    const text = document.getElementById('rosterInput').value;
    const lines = text.split('\n');
    rosterData = [];
    const lineRegex = /^(\d{2}\s[A-Za-z]{3})\s+.*?\s+(\d{4})\s+(\d{4})\s+(\d{1,2}:\d{2})\s+(\d{1,2}:\d{2})/;

    lines.forEach((line, index) => {
        const match = line.match(lineRegex);
        if (match) {
            const dutyMins = parseTime(match[4]);
            const credMins = parseTime(match[5]);
            const d60 = dutyMins * 0.6;
            rosterData.push({
                id: index, date: match[1], sOn: match[2], origSOf: match[3],
                origDuty: dutyMins, credit: credMins, origD60: d60, margin: credMins - d60
            });
        }
    });
    renderTable();
}

function renderTable() {
    let html = `<table><tr><th>Date</th><th>S-On</th><th>Roster S-Off</th><th>Duty</th><th>Credit</th><th>.6 Duty</th><th>Margin</th><th>New S-Off</th><th>New Duty</th><th>New .6</th><th>Extra Gross</th><th>Extra Net</th></tr>`;
    rosterData.forEach(row => {
        const isRed = row.margin <= 0.5;
        html += `<tr>
            <td>${row.date}</td><td>${row.sOn}</td><td>${row.origSOf}</td><td class="duty-col">${formatTime(row.origDuty)}</td><td>${formatTime(row.credit)}</td><td>${formatTime(row.origD60)}</td>
            <td class="${isRed ? 'margin-red' : 'margin-amber'}">${formatTime(Math.max(0, row.margin))}</td>
            <td><input type="text" maxlength="4" class="adj-input" id="in-${row.id}" oninput="run(${row.id})" placeholder="HHMM"></td>
            <td id="d100-${row.id}">-</td><td id="d60-${row.id}">-</td><td id="gr-${row.id}" class="extra-gross">$0.00</td><td id="net-${row.id}" class="extra-net">$0.00</td>
        </tr>`;
    });
    document.getElementById('tableContainer').innerHTML = html + "</table>";
}

function run(id) {
    const row = rosterData.find(r => r.id === id);
    const val = document.getElementById(`in-${id}`).value;
    const rate = parseFloat(document.getElementById('hourlyRate').value) || 0;
    const tax = (parseFloat(document.getElementById('taxRate').value) || 0) / 100;

    if (val.length === 4) {
        const origSOfMins = (parseInt(row.origSOf.substring(0,2)) * 60) + parseInt(row.origSOf.substring(2));
        let newSOfMins = (parseInt(val.substring(0,2)) * 60) + parseInt(val.substring(2));
        if (newSOfMins < origSOfMins - 600) newSOfMins += 1440; 
        
        const delta = newSOfMins - origSOfMins;
        const newTotalDuty = row.origDuty + delta;
        const newD60 = newTotalDuty * 0.6;
        
        const baselinePay = Math.max(row.credit, row.origD60);
        const simulatedPay = Math.max(row.credit, newD60);
        const diff = Math.max(0, simulatedPay - baselinePay);
        
        const gross = (diff / 60) * rate;
        
        // Dynamic Margin Highlighting for Simulation
        const marginEl = document.getElementById(`in-${id}`).parentElement.parentElement.cells[6];
        const newMargin = row.credit - newD60;
        
        if (newMargin < 0) {
            marginEl.className = "margin-green";
            marginEl.innerText = formatTime(Math.abs(newMargin));
        } else if (newMargin <= 0.5) {
            marginEl.className = "margin-red";
            marginEl.innerText = "0:00";
        } else {
            marginEl.className = "margin-amber";
            marginEl.innerText = formatTime(newMargin);
        }

        document.getElementById(`d100-${id}`).innerText = formatTime(newTotalDuty);
        document.getElementById(`d60-${id}`).innerText = formatTime(newD60);
        document.getElementById(`gr-${id}`).innerText = "$" + gross.toFixed(2);
        document.getElementById(`net-${id}`).innerText = "$" + (gross * (1 - tax)).toFixed(2);
    }
}
function updateAll() { rosterData.forEach(r => run(r.id)); }
</script>
</body>
</html>
